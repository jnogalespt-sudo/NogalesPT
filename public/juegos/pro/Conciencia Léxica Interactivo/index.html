<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Parque de las Palabras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;700&family=Outfit:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background: #f0f9ff;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .title-font { font-family: 'Fredoka One', cursive; }

        /* Estilos de los Trenes */
        .train-container {
            display: flex;
            align-items: center;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            border: 4px solid #e0f2fe;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            will-change: transform;
            min-width: 140px;
            justify-content: center;
        }

        @media (min-width: 640px) {
            .train-container {
                padding: 1.5rem 2.5rem;
                min-width: 200px;
            }
        }

        /* Bloques de palabras */
        .word-block {
            min-width: 100px;
            height: 70px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #ffffff;
            color: #1e40af;
            border: 4px solid #dbeafe;
            border-bottom-width: 6px;
        }

        @media (min-width: 640px) {
            .word-block {
                min-width: 120px;
                height: 80px;
                border-radius: 24px;
                font-size: 1.6rem;
                border-bottom-width: 8px;
            }
        }

        .word-block.active {
            transform: translateY(-6px);
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 4px solid #bae6fd;
            border-radius: 30px;
            height: 94vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .game-card {
                border-width: 6px;
                border-radius: 40px;
                height: 85vh;
            }
        }

        /* Zona de Cesta */
        .basket-zone {
            width: 180px;
            height: 180px;
            border: 6px dashed #fbbf24;
            border-radius: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fffbeb;
            transition: all 0.2s ease-out;
            position: relative;
        }
        
        @media (min-width: 640px) {
            .basket-zone {
                width: 240px;
                height: 240px;
                border-width: 8px;
                border-radius: 60px;
            }
        }
        
        .basket-mini {
            width: 130px !important;
            height: 130px !important;
            border-radius: 30px !important;
            border-width: 4px !important;
        }

        @media (min-width: 640px) {
            .basket-mini {
                width: 160px !important;
                height: 160px !important;
                border-radius: 40px !important;
                border-width: 6px !important;
            }
        }
        
        .basket-mini .basket-emoji { font-size: 3.5rem !important; }
        @media (min-width: 640px) { .basket-mini .basket-emoji { font-size: 4.5rem !important; } }

        .basket-zone.highlight {
            background: #fef3c7;
            border-color: #f59e0b;
            transform: scale(1.08);
            box-shadow: 0 0 40px rgba(245, 158, 11, 0.5);
        }

        .basket-emoji { font-size: 5rem; }
        @media (min-width: 640px) { .basket-emoji { font-size: 7rem; } }

        /* Estilos Pictopalabras */
        .drop-zone-picto {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 4px dashed #cbd5e1;
            min-height: 160px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 2rem;
            width: 100%;
            max-width: 240px;
        }
        .drop-zone-picto.highlight {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .picto-img-container {
            width: 100%;
            height: 100px;
            overflow: hidden;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .picto-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .icon-pictogram {
            font-size: 60px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            width: 100%;
        }

        .draggable-item {
            touch-action: none; 
            z-index: 50;
            cursor: grab;
            will-change: transform;
        }
        
        .is-dragging {
            cursor: grabbing !important;
            z-index: 9999 !important;
            pointer-events: none; 
        }

        .option-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-bottom: 5px solid rgba(0,0,0,0.2);
            margin: 0 6px;
        }

        @media (min-width: 640px) {
            .option-circle {
                width: 90px;
                height: 90px;
                font-size: 2.5rem;
                margin: 0 8px;
                border-bottom: 6px solid rgba(0,0,0,0.2);
            }
        }

        /* Estilos Logo NOGALES PT */
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            transform: scale(0.85);
        }

        @media (min-width: 640px) {
            .logo-container {
                margin-bottom: 2rem;
                transform: scale(1);
            }
        }

        .logo-box {
            width: 70px;
            height: 70px;
            background-color: #648e6c;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        @media (min-width: 640px) {
            .logo-box {
                width: 80px;
                height: 80px;
                border-radius: 22px;
                margin-bottom: 10px;
            }
        }

        .logo-text {
            font-family: sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            letter-spacing: -1.5px;
            display: flex;
            align-items: baseline;
            line-height: 1;
        }

        @media (min-width: 640px) {
            .logo-text { font-size: 3.2rem; letter-spacing: -2px; }
        }

        .text-nogales { color: #1a1e26; }
        .text-pt { color: #648e6c; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="main-app" class="w-full max-w-5xl relative flex flex-col">
        
        <div id="screen-intro" class="flex-grow flex flex-col items-center justify-center text-center animate__animated animate__fadeIn p-4">
            
            <div class="logo-container">
                <div class="logo-box">
                    <svg viewBox="0 0 24 24" class="w-10 h-10 sm:w-12 sm:h-12 text-white fill-none stroke-current stroke-2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                        <path d="M6 12.5V16a6 6 0 0 0 12 0v-3.5"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="text-nogales">NOGALES</span>
                    <span class="text-pt">PT</span>
                </div>
            </div>

            <h1 class="text-4xl sm:text-6xl md:text-7xl title-font text-blue-600 mb-2 drop-shadow-md px-2">
                Parque de <br>Palabras
            </h1>
            <p class="text-lg sm:text-xl text-blue-400 font-bold mb-8 italic uppercase tracking-wider">Conciencia L√©xica</p>
            
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-6 w-full max-w-4xl px-2">
                <button onclick="startActivity('count')" class="bg-blue-400 hover:bg-blue-500 text-white p-4 sm:p-6 rounded-3xl shadow-xl border-b-8 border-blue-600 transition-transform active:scale-95 flex flex-col items-center">
                    <span class="text-3xl sm:text-4xl block mb-2">‚öΩ</span>
                    <span class="text-xs sm:text-sm font-bold uppercase">Saltos</span>
                </button>
                <button onclick="startActivity('compare')" class="bg-green-400 hover:bg-green-500 text-white p-4 sm:p-6 rounded-3xl shadow-xl border-b-8 border-green-600 transition-transform active:scale-95 flex flex-col items-center">
                    <span class="text-3xl sm:text-4xl block mb-2">üöÇ</span>
                    <span class="text-xs sm:text-sm font-bold uppercase">Trenes</span>
                </button>
                <button onclick="startActivity('intruder')" class="bg-orange-400 hover:bg-orange-500 text-white p-4 sm:p-6 rounded-3xl shadow-xl border-b-8 border-orange-600 transition-transform active:scale-95 flex flex-col items-center">
                    <span class="text-3xl sm:text-4xl block mb-2">üïµÔ∏è</span>
                    <span class="text-xs sm:text-sm font-bold uppercase">Traviesa</span>
                </button>
                <button onclick="startActivity('picto')" class="bg-indigo-400 hover:bg-indigo-500 text-white p-4 sm:p-6 rounded-3xl shadow-xl border-b-8 border-indigo-600 transition-transform active:scale-95 flex flex-col items-center">
                    <span class="text-3xl sm:text-4xl block mb-2">üñºÔ∏è</span>
                    <span class="text-xs sm:text-sm font-bold uppercase">Picto</span>
                </button>
            </div>
        </div>

        <div id="screen-activity" class="hidden flex-grow game-card shadow-2xl relative animate__animated animate__zoomIn">
            <div class="p-3 sm:p-4 flex justify-between items-center bg-blue-50 border-b-4 border-blue-100 rounded-t-[30px] sm:rounded-t-[40px] sticky top-0 z-[60]">
                <button onclick="goHome()" class="bg-white text-blue-500 px-4 sm:px-6 py-2 rounded-full font-bold shadow-sm border-2 border-blue-100 hover:bg-blue-50 text-sm sm:text-base">üè† Inicio</button>
                <div id="activity-title" class="title-font text-lg sm:text-xl text-blue-600 flex-1 text-center px-2"></div>
                <div class="text-base sm:text-xl font-bold text-blue-400">Pts: <span id="score">0</span></div>
            </div>

            <!-- Ajuste de scroll y justificaci√≥n para evitar cortes -->
            <div id="scroll-area" class="flex-grow flex flex-col items-center justify-start pt-6 sm:pt-10 p-4 sm:p-8 overflow-y-auto overflow-x-hidden">
                <div id="instruction-display" class="text-lg sm:text-2xl md:text-3xl font-bold text-slate-700 mb-2 text-center max-w-2xl px-2 w-full flex-shrink-0"></div>
                <!-- Subt√≠tulo para frases en Picto -->
                <div id="phrase-display" class="text-base sm:text-xl text-blue-500 font-semibold mb-6 text-center italic hidden flex-shrink-0"></div>
                
                <div id="action-button-container" class="mb-2 sm:mb-4"></div>

                <button id="btn-listen" class="w-14 h-14 sm:w-16 sm:h-16 bg-yellow-400 rounded-full shadow-lg flex items-center justify-center text-2xl sm:text-3xl hover:bg-yellow-500 transition-all transform active:scale-90 mb-4 sm:mb-6 flex-shrink-0">
                    üîä
                </button>

                <div id="game-board" class="w-full flex flex-wrap justify-center items-center gap-4 sm:gap-6 min-h-[140px] mb-6 sm:mb-8"></div>
                <div id="destination-area" class="w-full flex flex-wrap justify-center gap-4 hidden min-h-[180px] mb-4"></div>

                <div id="feedback-area" class="mt-4 min-h-[100px] flex flex-col items-center justify-center flex-shrink-0">
                    <div id="feedback-text" class="text-2xl sm:text-3xl font-bold text-green-500 animate__animated mb-4"></div>
                    <div id="next-button-container" class="hidden">
                        <button onclick="nextRound()" class="bg-green-500 text-white px-8 sm:px-10 py-3 rounded-full text-lg sm:text-xl font-black shadow-lg hover:bg-green-600 animate__animated animate__pulse animate__infinite">
                            SIGUIENTE ‚û°Ô∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let voice = null;
        let score = 0;
        let currentActivity = '';
        let currentTarget = null;
        let selectedCount = 0;
        let pictoMatches = 0;
        let currentUtterance = null;
        let hasSaidMoveInstruction = false;

        const usedIndices = { count: [], compare: [], intruder: [], picto: [] };

        const data = {
            count: [
                { sentence: "El perro corre", words: ["El", "perro", "corre"] },
                { sentence: "Mi abuela cocina galletas", words: ["Mi", "abuela", "cocina", "galletas"] },
                { sentence: "El sol brilla", words: ["El", "sol", "brilla"] },
                { sentence: "La ni√±a salta la cuerda roja", words: ["La", "ni√±a", "salta", "la", "cuerda", "roja"] },
                { sentence: "Yo como pan", words: ["Yo", "como", "pan"] },
                { sentence: "Pap√° lee el peri√≥dico nuevo", words: ["Pap√°", "lee", "el", "peri√≥dico", "nuevo"] },
                { sentence: "El gato negro duerme mucho hoy", words: ["El", "gato", "negro", "duerme", "mucho", "hoy"] },
                { sentence: "Tengo sed", words: ["Tengo", "sed"] },
                { sentence: "La flor huele muy bien", words: ["La", "flor", "huele", "muy", "bien"] },
                { sentence: "Me gusta jugar", words: ["Me", "gusta", "jugar"] },
                { sentence: "El p√°jaro canta alto", words: ["El", "p√°jaro", "canta", "alto"] },
                { sentence: "Mi casa es bonita", words: ["Mi", "casa", "es", "bonita"] },
                { sentence: "Me gusta el chocolate", words: ["Me", "gusta", "el", "chocolate"] },
                { sentence: "El coche va r√°pido", words: ["El", "coche", "va", "r√°pido"] },
                { sentence: "La luna brilla mucho", words: ["La", "luna", "brilla", "mucho"] },
                { sentence: "Tengo un libro nuevo", words: ["Tengo", "un", "libro", "nuevo"] },
                { sentence: "El pez nada bien", words: ["El", "pez", "nada", "bien"] },
                { sentence: "Mam√° cocina muy rico", words: ["Mam√°", "cocina", "muy", "rico"] },
                { sentence: "El √°rbol tiene hojas", words: ["El", "√°rbol", "tiene", "hojas"] },
                { sentence: "Mi amigo es alto", words: ["Mi", "amigo", "es", "alto"] },
                { sentence: "El beb√© duerme poco", words: ["El", "beb√©", "duerme", "poco"] }
            ],
            compare: [
                { s1: "El sol sale", s2: "El sol sale por la ma√±ana temprano", longer: 2 },
                { s1: "Mi mam√° me quiere mucho", s2: "Yo juego", longer: 1 },
                { s1: "La vaca da leche", s2: "La vaca blanca da mucha leche", longer: 2 },
                { s1: "El nene corre", s2: "El nene corre por el jard√≠n de su casa", longer: 2 },
                { s1: "Gato come", s2: "El gato negro come su comida rica", longer: 2 },
                { s1: "Veo flores", s2: "En el campo veo muchas flores rojas", longer: 2 },
                { s1: "El p√°jaro vuela alto", s2: "P√°jaro vuela", longer: 1 },
                { s1: "Salto mucho", s2: "Yo salto mucho en la cama el√°stica", longer: 2 },
                { s1: "Mi casa es azul", s2: "Casa azul", longer: 1 },
                { s1: "El coche corre por la calle", s2: "Coche corre", longer: 1 },
                { s1: "Tengo un perro", s2: "Tengo un perro peque√±o y muy juguet√≥n", longer: 2 },
                { s1: "La sopa quema", s2: "Sopa quema", longer: 1 },
                { s1: "Mi hermana baila", s2: "Mi hermana baila ballet en el teatro", longer: 2 },
                { s1: "Llueve hoy", s2: "Hoy llueve mucho y hace fr√≠o", longer: 2 },
                { s1: "El oso duerme en la cueva", s2: "Oso duerme", longer: 1 },
                { s1: "Pan rico", s2: "El pan est√° muy rico y tierno", longer: 2 },
                { s1: "La luna brilla", s2: "La luna brilla en el cielo oscuro", longer: 2 },
                { s1: "Mi mochila es verde", s2: "Mochila verde", longer: 1 },
                { s1: "Como fruta", s2: "Yo como fruta todos los d√≠as", longer: 2 },
                { s1: "El tren pita fuerte", s2: "Tren pita", longer: 1 }
            ],
            intruder: [
                { sentence: "El perro ladra", intruder: "helado", words: ["El", "perro", "ladra"] },
                { sentence: "Hoy comer√© sopa", intruder: "avi√≥n", words: ["Hoy", "comer√©", "sopa"] },
                { sentence: "La vaca come", intruder: "tren", words: ["La", "vaca", "come"] },
                { sentence: "Mi zapato es azul", intruder: "pi√±a", words: ["Mi", "zapato", "es", "azul"] },
                { sentence: "El sol brilla", intruder: "zapato", words: ["El", "sol", "brilla"] },
                { sentence: "El gato duerme", intruder: "silla", words: ["El", "gato", "duerme"] },
                { sentence: "Mam√° lee libro", intruder: "coche", words: ["Mam√°", "lee", "libro"] },
                { sentence: "P√°jaro vuela alto", intruder: "manzana", words: ["P√°jaro", "vuela", "alto"] },
                { sentence: "Pez nada agua", intruder: "bota", words: ["Pez", "nada", "agua"] },
                { sentence: "Flor roja bonita", intruder: "l√°piz", words: ["Flor", "roja", "bonita"] },
                { sentence: "Yo salto cuerda", intruder: "martillo", words: ["Yo", "salto", "cuerda"] },
                { sentence: "Nene llora mucho", intruder: "mesa", words: ["Nene", "llora", "mucho"] },
                { sentence: "Sol sale ma√±ana", intruder: "gafas", words: ["Sol", "sale", "man√±ana"] },
                { sentence: "Tengo hambre ahora", intruder: "reloj", words: ["Tengo", "hambre", "ahora"] },
                { sentence: "Pelota rebota suelo", intruder: "camisa", words: ["Pelota", "rebota", "suelo"] },
                { sentence: "Casa grande blanca", intruder: "tenedor", words: ["Casa", "grande", "blanca"] },
                { sentence: "Pan con queso", intruder: "estrella", words: ["Pan", "con", "queso"] },
                { sentence: "Luna brilla noche", intruder: "calcet√≠n", words: ["Luna", "brilla", "noche"] },
                { sentence: "Fruta es sana", intruder: "cuadro", words: ["Fruta", "es", "sana"] },
                { sentence: "Agua est√° fr√≠a", intruder: "llave", words: ["Agua", "est√°", "fr√≠a"] }
            ],
            picto: [
                { s: "El perro y el gato juegan", t: [{w:"perro", i:"https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=400"}, {w:"gato", i:"https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400"}] },
                { s: "La ni√±a come una manzana", t: [{w:"ni√±a", i:"https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?w=400"}, {w:"manzana", i:"https://images.unsplash.com/photo-1570913149827-d2ac84ab3f9a?w=400"}] },
                { s: "El ni√±o conduce el coche", t: [{w:"ni√±o", icon:"üë¶"}, {w:"coche", i:"https://images.unsplash.com/photo-1494976388531-d1058494cdd8?w=400"}] },
                { s: "El p√°jaro vuela al √°rbol", t: [{w:"p√°jaro", icon:"üê¶"}, {w:"√°rbol", i:"https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=400"}] },
                { s: "La abuela vive en la casa", t: [{w:"abuela", i:"https://images.unsplash.com/photo-1581579438747-1dc8d17bbce4?w=400"}, {w:"casa", i:"https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=400"}] },
                { s: "El elefante bebe mucha agua", t: [{w:"elefante", i:"https://images.unsplash.com/photo-1557050543-4d5f4e07ef46?w=400"}, {w:"agua", icon:"üíß"}] },
                { s: "El cocinero prepara una pizza", t: [{w:"cocinero", i:"https://images.unsplash.com/photo-1583394293214-28ded15ee548?w=400"}, {w:"pizza", i:"https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400"}] },
                { s: "El astronauta mira la luna", t: [{w:"astronauta", icon:"üë®‚ÄçüöÄ"}, {w:"luna", icon:"üåô"}] },
                { s: "El doctor est√° en el hospital", t: [{w:"doctor", i:"https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=400"}, {w:"hospital", icon:"üè•"}] },
                { s: "El le√≥n corre por la selva", t: [{w:"le√≥n", icon:"ü¶Å"}, {w:"selva", icon:"üåø"}] },
                { s: "El mono come un pl√°tano", t: [{w:"mono", i:"https://images.unsplash.com/photo-1540573133985-87b6da6d54a9?w=400"}, {w:"pl√°tano", icon:"üçå"}] },
                { s: "La tortuga llega a la playa", t: [{w:"tortuga", icon:"üê¢"}, {w:"playa", i:"https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400"}] },
                { s: "El bombero apaga el fuego", t: [{w:"bombero", icon:"üë®‚Äçüöí"}, {w:"fuego", icon:"üî•"}] },
                { s: "El cartero trae una carta", t: [{w:"cartero", icon:"üì¨"}, {w:"carta", icon:"‚úâÔ∏è"}] },
                { s: "El pintor termina el cuadro", t: [{w:"pintor", icon:"üë®‚Äçüé®"}, {w:"cuadro", icon:"üñºÔ∏è"}] },
                { s: "El granjero cuida a la vaca", t: [{w:"granjero", icon:"üë®‚Äçüåæ"}, {w:"vaca", i:"https://images.unsplash.com/photo-1546445317-29f4545e9d53?w=400"}] },
                { s: "El pez nada en el mar", t: [{w:"pez", i:"https://images.unsplash.com/photo-1524704654690-b56c05c78a00?w=400"}, {w:"mar", i:"https://images.unsplash.com/photo-1439405326854-014607f694d7?w=400"}] },
                { s: "El conejo muerde la zanahoria", t: [{w:"conejo", i:"https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?w=400"}, {w:"zanahoria", i:"https://images.unsplash.com/photo-1598170845058-32b9d6a5da37?w=400"}] },
                { s: "El carpintero usa el martillo", t: [{w:"carpintero", icon:"ü™ö"}, {w:"martillo", icon:"üî®"}] },
                { s: "El beb√© toma el biber√≥n", t: [{w:"beb√©", icon:"üë∂"}, {w:"biber√≥n", icon:"üçº"}] }
            ]
        };

        function loadVoice() {
            const voices = synth.getVoices();
            voice = voices.find(v => v.name.includes('Monica') && v.lang.includes('es')) || 
                    voices.find(v => v.name.includes('Jorge') && v.lang.includes('es')) ||
                    voices.find(v => v.name.includes('Paulina') && v.lang.includes('es')) ||
                    voices.find(v => v.lang.startsWith('es') && v.name.includes('Google')) || 
                    voices.find(v => v.lang.startsWith('es'));
        }

        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoice;

        function speak(text, callback = null) {
            synth.cancel();
            if (currentUtterance) currentUtterance.onend = null;
            if (!voice) loadVoice();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voice;
            utterance.lang = 'es-ES';
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            if (callback) utterance.onend = () => { callback(); currentUtterance = null; };
            currentUtterance = utterance;
            setTimeout(() => { synth.speak(utterance); }, 100);
        }

        function getNextTarget(type) {
            const list = data[type];
            if (usedIndices[type].length >= list.length) usedIndices[type] = [];
            let idx;
            do { idx = Math.floor(Math.random() * list.length); } while (usedIndices[type].includes(idx));
            usedIndices[type].push(idx);
            return list[idx];
        }

        function goHome() {
            document.getElementById('screen-intro').classList.remove('hidden');
            document.getElementById('screen-activity').classList.add('hidden');
            synth.cancel();
            hasSaidMoveInstruction = false;
        }

        function startActivity(type) {
            currentActivity = type;
            document.getElementById('screen-intro').classList.add('hidden');
            document.getElementById('screen-activity').classList.remove('hidden');
            const titles = { 'count': 'Saltos', 'compare': 'Trenes', 'intruder': 'La Palabra Traviesa', 'picto': 'Pictopalabras' };
            document.getElementById('activity-title').innerText = titles[type];
            nextRound();
        }

        function nextRound() {
            const board = document.getElementById('game-board');
            const destArea = document.getElementById('destination-area');
            const inst = document.getElementById('instruction-display');
            const phraseDisp = document.getElementById('phrase-display');
            const listenBtn = document.getElementById('btn-listen');
            const nextContainer = document.getElementById('next-button-container');

            destArea.className = "w-full flex flex-wrap justify-center gap-4 hidden min-h-[180px] mb-4";
            board.innerHTML = '';
            destArea.innerHTML = '';
            phraseDisp.innerText = '';
            phraseDisp.classList.add('hidden');
            document.getElementById('feedback-text').innerText = '';
            nextContainer.classList.add('hidden');
            const oldOptions = document.getElementById('count-options');
            if(oldOptions) oldOptions.remove();

            selectedCount = 0;
            pictoMatches = 0;
            currentTarget = getNextTarget(currentActivity);

            if (currentActivity === 'count') {
                inst.innerText = "Escucha y toca cada palabra";
                listenBtn.classList.remove('hidden');
                listenBtn.onclick = () => speak(currentTarget.sentence);
                speak(currentTarget.sentence);
                currentTarget.words.forEach((w) => {
                    const b = document.createElement('div');
                    b.className = "word-block animate__animated animate__fadeInUp";
                    b.innerText = w;
                    b.onclick = (e) => {
                        e.stopPropagation();
                        if(!b.classList.contains('active')) {
                            b.classList.add('active');
                            selectedCount++;
                            if(selectedCount === currentTarget.words.length) {
                                speak(w, () => { setTimeout(askCount, 300); });
                            } else { speak(w); }
                        }
                    };
                    board.appendChild(b);
                });
            } else if (currentActivity === 'compare') {
                inst.innerText = "Escucha los trenes y mueve el m√°s largo a la cesta";
                listenBtn.classList.add('hidden');
                destArea.classList.remove('hidden');
                const basket = document.createElement('div');
                basket.className = "basket-zone animate__animated animate__fadeInUp";
                basket.innerHTML = `<span class="basket-emoji">üß∫</span><p class="font-bold text-amber-600 text-sm sm:text-lg uppercase tracking-widest text-center px-2">CESTA</p>`;
                destArea.appendChild(basket);
                if (!hasSaidMoveInstruction) { speak("Escucha estos trenes. Mueve el tren m√°s largo a la cesta."); hasSaidMoveInstruction = true; }
                [1, 2].forEach(id => {
                    const s = id === 1 ? currentTarget.s1 : currentTarget.s2;
                    const train = document.createElement('div');
                    train.className = "draggable-item train-container animate__animated animate__fadeInLeft";
                    train.innerHTML = `<div class="text-xl sm:text-3xl font-black text-blue-600">Tren ${id}</div>`;
                    train.onpointerdown = (e) => {
                        speak(s); 
                        startDrag(e, train, basket, (isInside) => {
                            if (isInside) {
                                if (id === currentTarget.longer) { 
                                    speak("¬°Muy bien! Es el tren m√°s largo."); 
                                    train.remove(); 
                                    showWin(); 
                                    return true;
                                } else { 
                                    speak("¬°Ese es m√°s corto!"); 
                                    return false; 
                                }
                            }
                            return false;
                        });
                    };
                    board.appendChild(train);
                });
            } else if (currentActivity === 'intruder') {
                inst.innerText = "¬°Lanza la palabra traviesa a la cesta!";
                destArea.className = "fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-[70] flex";
                destArea.classList.remove('hidden');
                listenBtn.classList.remove('hidden');
                const correctSentence = currentTarget.words.join(" ");
                speak("Escucha esta frase: " + correctSentence + ". ¬øQu√© palabra sobra?");
                listenBtn.onclick = () => speak(correctSentence);
                const basket = document.createElement('div');
                basket.className = "basket-zone basket-mini animate__animated animate__fadeInUp shadow-2xl";
                basket.innerHTML = `<span class="basket-emoji">üß∫</span><p class="font-bold text-amber-600 text-[10px] sm:text-sm">CESTA</p>`;
                destArea.appendChild(basket);
                const allWords = [...currentTarget.words, currentTarget.intruder].sort(() => Math.random() - 0.5);
                allWords.forEach(w => {
                    const item = document.createElement('div');
                    item.className = "draggable-item px-4 py-3 sm:px-6 sm:py-4 bg-orange-50 border-4 border-orange-200 rounded-2xl sm:rounded-3xl text-xl sm:text-2xl font-bold text-orange-700 shadow-sm";
                    item.innerText = w;
                    item.onpointerdown = (e) => {
                        speak(w); 
                        startDrag(e, item, basket, (isInside) => {
                            if (isInside && w === currentTarget.intruder) { 
                                speak("¬°A la cesta! Esa palabra no estaba en la frase."); 
                                item.remove();
                                showWin(); 
                                return true;
                            } else if (isInside) { 
                                speak("¬°Esta palabra s√≠ es de la frase!"); 
                                return false;
                            }
                            return false;
                        });
                    };
                    board.appendChild(item);
                });
            } else if (currentActivity === 'picto') {
                inst.innerText = "¬°Encuentra la palabra con la imagen!";
                phraseDisp.innerText = `"${currentTarget.s}"`; // Mostrar frase visualmente
                phraseDisp.classList.remove('hidden');
                listenBtn.classList.remove('hidden');
                listenBtn.onclick = () => speak(currentTarget.s);
                speak(currentTarget.s);
                destArea.classList.remove('hidden');
                const zones = [];
                currentTarget.t.forEach(target => {
                    const zone = document.createElement('div');
                    zone.className = 'drop-zone-picto p-4 shadow-sm';
                    const content = target.icon ? `<div class="icon-pictogram">${target.icon}</div>` : `<div class="picto-img-container"><img src="${target.i}"></div>`;
                    zone.innerHTML = `${content}<div class="text-slate-300 font-black text-center text-sm border-2 border-dashed border-slate-100 rounded-xl py-2 w-full uppercase">¬øQu√© es?</div>`;
                    zone.dataset.word = target.w.toLowerCase();
                    destArea.appendChild(zone);
                    zones.push(zone);
                });
                currentTarget.s.split(' ').forEach(w => {
                    const cleanWord = w.replace(/[.,]/g, '').toLowerCase();
                    const card = document.createElement('div');
                    card.className = 'draggable-item px-4 py-2 bg-white border-4 border-slate-100 rounded-2xl text-xl font-bold text-slate-700 shadow-sm';
                    card.innerText = w.replace(/[.,]/g, '');
                    card.onpointerdown = (e) => {
                        speak(card.innerText);
                        startDrag(e, card, zones, (matchedZone) => {
                            if (matchedZone && matchedZone.dataset.word === cleanWord) {
                                matchedZone.innerHTML = `<div class="flex flex-col items-center animate-pop"><div class="text-5xl mb-2">${matchedZone.querySelector('img') ? 'üñºÔ∏è' : '‚ú®'}</div><div class="bg-emerald-500 text-white px-6 py-2 rounded-xl font-black">${cleanWord.toUpperCase()}</div></div>`;
                                matchedZone.classList.add('bg-emerald-50', 'border-emerald-200');
                                card.remove();
                                pictoMatches++;
                                speak("¬°Bien!");
                                if (pictoMatches === currentTarget.t.length) showWin();
                                return true;
                            } else if (matchedZone) { speak("¬°Casi!"); }
                            return false;
                        });
                    };
                    board.appendChild(card);
                });
            }
        }

        function startDrag(e, el, targetInput, callback) {
            const startX = e.clientX;
            const startY = e.clientY;
            let isActuallyDragging = false;
            let initialRect, offsetX, offsetY;
            const targetZones = Array.isArray(targetInput) ? targetInput : [targetInput];

            const moveHandler = (ev) => {
                if (!isActuallyDragging) {
                    const dist = Math.sqrt(Math.pow(ev.clientX - startX, 2) + Math.pow(ev.clientY - startY, 2));
                    if (dist > 10) {
                        isActuallyDragging = true;
                        el.setPointerCapture(e.pointerId);
                        el.classList.add('is-dragging');
                        initialRect = el.getBoundingClientRect();
                        offsetX = startX - initialRect.left;
                        offsetY = startY - initialRect.top;
                        el.style.position = 'fixed';
                        el.style.width = initialRect.width + 'px';
                        el.style.left = initialRect.left + 'px';
                        el.style.top = initialRect.top + 'px';
                        el.style.transform = 'scale(0.95)';
                    }
                    return;
                }
                const nx = ev.clientX - offsetX;
                const ny = ev.clientY - offsetY;
                el.style.left = nx + 'px';
                el.style.top = ny + 'px';
                el.style.transform = `scale(0.95) rotate(${(ev.clientX - e.clientX) / 20}deg)`;

                targetZones.forEach(zone => {
                    const tRect = zone.getBoundingClientRect();
                    const elRect = el.getBoundingClientRect();
                    const cx = elRect.left + elRect.width / 2;
                    const cy = elRect.top + elRect.height / 2;
                    if (cx > tRect.left && cx < tRect.right && cy > tRect.top && cy < tRect.bottom) zone.classList.add('highlight');
                    else zone.classList.remove('highlight');
                });
            };

            const upHandler = (ev) => {
                window.removeEventListener('pointermove', moveHandler);
                window.removeEventListener('pointerup', upHandler);
                if (!isActuallyDragging) return;
                el.classList.remove('is-dragging');
                el.releasePointerCapture(e.pointerId);
                
                let foundZone = null;
                targetZones.forEach(zone => {
                    const tRect = zone.getBoundingClientRect();
                    const elRect = el.getBoundingClientRect();
                    const cx = elRect.left + elRect.width / 2;
                    const cy = elRect.top + elRect.height / 2;
                    zone.classList.remove('highlight');
                    if (cx > tRect.left && cx < tRect.right && cy > tRect.top && cy < tRect.bottom) foundZone = zone;
                });

                const success = callback(foundZone);
                
                if (!success) {
                    el.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    el.style.left = initialRect.left + 'px';
                    el.style.top = initialRect.top + 'px';
                    el.style.transform = 'scale(1)';
                    setTimeout(() => { if (el) { el.style.position = ''; el.style.left = ''; el.style.top = ''; el.style.width = ''; el.style.transition = ''; } }, 400);
                }
            };
            window.addEventListener('pointermove', moveHandler);
            window.addEventListener('pointerup', upHandler);
        }

        function askCount() {
            if (document.getElementById('count-options')) return;
            const board = document.getElementById('game-board');
            const inst = document.getElementById('instruction-display');
            inst.innerText = "¬øCu√°ntas palabras son?";
            speak(inst.innerText);
            const optionsContainer = document.createElement('div');
            optionsContainer.id = "count-options";
            optionsContainer.className = "w-full flex justify-center items-center mt-6 sm:mt-8 animate__animated animate__fadeInUp";
            const correct = currentTarget.words.length;
            const options = [correct-1, correct, correct+1].filter(n => n > 0).sort(()=>Math.random()-0.5);
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = "option-circle bg-purple-500 shadow-lg hover:scale-110 transition-transform active:scale-90";
                btn.innerText = opt;
                btn.onclick = () => {
                    if(opt === correct) { optionsContainer.remove(); showWin(); }
                    else { speak("¬°Casi! Cuenta otra vez."); btn.classList.add('animate__shakeX', 'bg-red-400'); setTimeout(() => btn.classList.remove('animate__shakeX'), 500); }
                };
                optionsContainer.appendChild(btn);
            });
            board.after(optionsContainer);
        }

        function showWin() {
            score += 10;
            document.getElementById('score').innerText = score;
            document.getElementById('feedback-text').innerText = "¬°ESTUPENDO! üåü";
            document.getElementById('next-button-container').classList.remove('hidden');
            speak("¬°Lo has hecho genial!");
        }
        window.onload = () => { loadVoice(); };
    </script>
</body>
</html>